<html>
<head>
	<title>Squares</title>

	<link href='http://fonts.googleapis.com/css?family=Bubbler+One' rel='stylesheet' type='text/css'>

	<link rel='stylesheet' href='css/styles.css' type='text/css'></link>

</head>
<body>

	<div id="config-bar">
		<div id='config-content'>
			<p>config</p>
			<table id='config-table' class='hidden'>
				<tr>
				<td>
					Harmony<input type='range' name='harmony' min='1' max='10'>
				</td>
				</tr>
				<tr>
				<td>
					Entropy<input type='range' name='entropy' min='1' max='10'>
				</tr>
				</td>
				<tr>
				<td>
					<input id="submit" type="button" value="Submit">
				</td>
				</tr>
			</table>
		</div>
	</div>

	<div id="gen-piano">
		<table>
			<tr>
				<td> &nbsp; </td>
				<td id="gen-key-c#"> c# </td>
				<td> &nbsp; </td>
				<td id="gen-key-d#"> d# </td>
				<td> &nbsp; </td>
				<td> &nbsp; </td>
				<td id="gen-key-f#"> f# </td>
				<td> &nbsp; </td>
				<td id="gen-key-g#"> g# </td>
				<td> &nbsp; </td>
				<td id="gen-key-a#"> a# </td>
				<td> &nbsp; </td>
			</tr>
			<tr>
				<td id="gen-key-c"> c </td>
				<td> &nbsp; </td>
				<td id="gen-key-d"> d </td>
				<td> &nbsp; </td>
				<td id="gen-key-e"> e </td>
				<td id="gen-key-f"> f </td>
				<td> &nbsp; </td>
				<td id="gen-key-g"> g </td>
				<td> &nbsp; </td>
				<td id="gen-key-a"> a </td>
				<td> &nbsp; </td>
				<td id="gen-key-b"> b </td>
			</tr>
		</table>
	</div>

	<div id="content">
		<p>yo
	</div>


	<div id="piano">
		<table>
			<tr>
				<td> &nbsp; </td>
				<td id="key-c#"> c# </td>
				<td> &nbsp; </td>
				<td id="key-d#"> d# </td>
				<td> &nbsp; </td>
				<td> &nbsp; </td>
				<td id="key-f#"> f# </td>
				<td> &nbsp; </td>
				<td id="key-g#"> g# </td>
				<td> &nbsp; </td>
				<td id="key-a#"> a# </td>
				<td> &nbsp; </td>
			</tr>
			<tr>
				<td id="key-c"> c </td>
				<td> &nbsp; </td>
				<td id="key-d"> d </td>
				<td> &nbsp; </td>
				<td id="key-e"> e </td>
				<td id="key-f"> f </td>
				<td> &nbsp; </td>
				<td id="key-g"> g </td>
				<td> &nbsp; </td>
				<td id="key-a"> a </td>
				<td> &nbsp; </td>
				<td id="key-b"> b </td>
			</tr>
		</table>
	</div>

</body>


<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
<script src="libs/timbre.js" type="text/javascript"></script>
<script src="libs/subcollider.js" type="text/javascript"></script>
<script src="js/keyboard.js" type="text/javascript"></script>
<script src="js/counterpoint.js" type="text/javascript"></script>

<script type="text/javascript">

	$(document).ready(function() {
	
		var noteMap = new Object();
		noteMap[60] = " c ";
		noteMap[61] = " c# ";
		noteMap[62] = " d ";
		noteMap[63] = " d# ";
		noteMap[64] = " e ";
		noteMap[65] = " f ";
		noteMap[66] = " f# ";
		noteMap[67] = " g ";
		noteMap[68] = " g# ";
		noteMap[69] = " a ";
		noteMap[70] = " a# ";
		noteMap[71] = " b ";

		function animateKey(key, on) {
			if (on) {
				$(key).animate({
					opacity: 0.75,
					color: "white",
					backgroundColor: "red"
				}, 100);
			} else {
				$(key).animate({
					opacity: 1,
					color: "black",
					backgroundColor: "blue"
				}, 100);
			}
		}

		startTheMusic();

		timbre.rec(function(output) {

			var msec  = timbre.timevalue("bpm140 l8");
			var synth = T("OscGen", {env:T("perc", {r:msec, ar:true})});

			T("interval", {interval:msec}, function(count) {
				if (count < cantusNotes.length) {
					synth.noteOn(cantusNotes[count], 100);
					var key = $('#gen-piano td');
					$.each(key, function(i, v) {
						if ($(v).text() == noteMap[cantusNotes[count]]) {
							animateKey($(v), true);
						}
					});
				} else {
					output.done();
				}
			}).start();

			output.send(synth);

		}).then(function(result) {

			var L = T("buffer", {buffer:result, loop:false});
			var R = T("buffer", {buffer:result, loop:false});

			var num = 400;
			var duration = L.duration;

			R.pitch = (duration * (num - 1)) / (duration * num);

			T("delay", {time:"bpm140 l16", fb:0.1, cross:true},
				T("pan", {pos:-0.6}, L), T("pan", {pos:+0.6}, R)
			).play();

		});

		var bar = $('#config-bar');
		var config_text = $($(bar.children()[0]).children()[0]);
		var config_table = $($(bar.children()[0]).children()[1]);
		var submit = $('#submit');

		// submit
		submit.click(function() {

			config_table.fadeOut(450, function() {
				config_text.fadeIn(450);
			});
			bar.animate(
				{ 'top': '+=20%' },
				450,
				'swing',
				function() {
					bar.removeClass('click');
				}
			);


		});
		// submit


		// config bar animators
		bar.click(function () {
			if (!bar.hasClass('click')) {
				config_text.fadeOut(450, function() {
					config_table.fadeIn(250);
				});
				bar.animate(
					{ 'top': '-=20%' },
					350,
					'swing',
					function() {
						bar.addClass('click');
					}
				);
			}
		});


		// adjust pianos
		$('#gen-piano td').width($(document).width() / 12);
		$('#gen-piano td').height($(document).height() / 10 );

		$('#piano td').width($(document).width() / 12);
		$('#piano td').height($(document).height() / 10 );


		// playable piano
		var synth = T("OscGen", {wave:"sine", mul:0.25}).play();

		var keydict = T("ndict.key");
		var midicps = T("midicps");
		T("keyboard").on("keydown", function(e) {
			var midi = keydict.at(e.keyCode);
			if (midi) {
				var freq = midicps.at(midi);
				synth.noteOnWithFreq(freq, 100);
				$.each($('#piano').find('table tr').children(), function(i, v) {
					if (noteMap[midi] == $(v).text()) {
						animateKey($(v), true);
					}
				});
			}
		}).on("keyup", function(e) {
			var midi = keydict.at(e.keyCode);
			if (midi) {
				synth.noteOff(midi, 100);
				$.each($('#piano').find('table tr').children(), function(i, v) {
					if (noteMap[midi] == $(v).text()) {
						animateKey($(v), false);
					}
				});
			}
		}).start();

	});

</script>



</html>
